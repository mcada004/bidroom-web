rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Shared auth helpers.
    function isSignedIn() {
      return request.auth != null;
    }

    function tripDoc(tripId) {
      return get(/databases/$(database)/documents/trips/$(tripId));
    }

    function isTripManager(tripId) {
      return isSignedIn() && tripDoc(tripId).data.createdByUid == request.auth.uid;
    }

    match /trips/{tripId} {
      // Public read so guests can open invite links without auth.
      allow read: if true;

      // Trip creation must be authenticated and self-owned.
      allow create: if isSignedIn() && request.resource.data.createdByUid == request.auth.uid;

      // Manager-only trip lifecycle/settings updates.
      // Also allow signed-in bidders to extend only auctionEndAt (anti-sniping).
      allow update, delete: if isTripManager(tripId) || (
        isSignedIn() &&
        resource.data.status == "live" &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(["auctionEndAt"]) &&
        request.resource.data.auctionEndAt is timestamp &&
        request.resource.data.auctionEndAt > resource.data.auctionEndAt
      );

      match /rooms/{roomId} {
        // Public read for live auction viewing.
        allow read: if true;

        // Room creation/deletion and manager edits stay manager-only.
        allow create, delete: if isTripManager(tripId);

        // Manager can update any room fields.
        // Signed-in bidders can only update current-high-bid tracking fields.
        allow update: if isTripManager(tripId) || (
          isSignedIn() &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly([
            "currentHighBidAmount",
            "currentHighBidderUid",
            "currentHighBidAt",
            "currentHighBidTimeMs"
          ]) &&
          request.resource.data.currentHighBidderUid == request.auth.uid &&
          request.resource.data.currentHighBidAmount is number &&
          request.resource.data.currentHighBidAmount >= resource.data.currentHighBidAmount &&
          request.resource.data.currentHighBidTimeMs is number &&
          (
            !(resource.data.currentHighBidTimeMs is number) ||
            request.resource.data.currentHighBidTimeMs >= resource.data.currentHighBidTimeMs
          )
        );

        match /bids/{bidId} {
          // Public read so guests can view live/final auction history if needed.
          allow read: if true;

          // Only signed-in users can place their own bids.
          allow create: if isSignedIn() &&
            request.resource.data.bidderUid == request.auth.uid &&
            request.resource.data.amount is number &&
            request.resource.data.bidTimeMs is number;

          // Bids are append-only.
          allow update, delete: if false;
        }
      }

      match /members/{memberUid} {
        // Member identities are visible only to signed-in users.
        allow read: if isSignedIn();

        // Users can create/update their own member profile.
        allow create, update: if isSignedIn() && request.auth.uid == memberUid;

        // Manager or self can remove a membership record.
        allow delete: if isTripManager(tripId) || (isSignedIn() && request.auth.uid == memberUid);
      }
    }
  }
}
