rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Shared auth helpers.
    function isSignedIn() {
      return request.auth != null &&
        request.auth.token.firebase.sign_in_provider != "anonymous";
    }

    function tripDoc(tripId) {
      return get(/databases/$(database)/documents/trips/$(tripId));
    }

    function isTripManager(tripId) {
      return isSignedIn() && tripDoc(tripId).data.createdByUid == request.auth.uid;
    }

    function isBanned(tripId) {
      return request.auth != null &&
        tripDoc(tripId).data.bannedUids is list &&
        tripDoc(tripId).data.bannedUids.hasAny([request.auth.uid]);
    }

    function isValidMemberPayload(tripId, memberUid) {
      return request.resource.data.keys().hasOnly(["displayName", "role", "joinedAt"]) &&
        request.resource.data.displayName is string &&
        request.resource.data.displayName.size() >= 2 &&
        request.resource.data.displayName.size() <= 24 &&
        request.resource.data.joinedAt is timestamp &&
        (
          request.resource.data.role == "participant" ||
          (
            request.resource.data.role == "manager" &&
            tripDoc(tripId).data.createdByUid == memberUid
          )
        );
    }

    function hasValidListingUrl(data) {
      return !data.keys().hasAny(["listingUrl"]) ||
        data.listingUrl == null ||
        (data.listingUrl is string && data.listingUrl.matches('^https?://.+'));
    }

    function hasAllowedManagerTripUpdate(before, after) {
      return hasValidListingUrl(after) &&
        after.diff(before).changedKeys().hasOnly([
          "name",
          "listingUrl",
          "listingTitle",
          "listingImageUrl",
          "listingDescription",
          "listingSiteName",
          "totalPrice",
          "roomCount",
          "auctionDurationHours",
          "bidIncrement",
          "antiSnipeWindowMinutes",
          "antiSnipeExtendMinutes",
          "bannedUids",
          "status",
          "auctionStartAt",
          "auctionEndAt",
          "updatedAt"
        ]) &&
        (!after.keys().hasAny(["name"]) || (after.name is string && after.name.size() > 0 && after.name.size() <= 120)) &&
        (!after.keys().hasAny(["totalPrice"]) || (after.totalPrice is number && after.totalPrice > 0)) &&
        (!after.keys().hasAny(["roomCount"]) || (after.roomCount is number && after.roomCount >= 1)) &&
        (!after.keys().hasAny(["auctionDurationHours"]) || (after.auctionDurationHours is number && after.auctionDurationHours >= 1)) &&
        (!after.keys().hasAny(["bidIncrement"]) || (after.bidIncrement is number && after.bidIncrement >= 1)) &&
        (!after.keys().hasAny(["antiSnipeWindowMinutes"]) || (after.antiSnipeWindowMinutes is number && after.antiSnipeWindowMinutes >= 0)) &&
        (!after.keys().hasAny(["antiSnipeExtendMinutes"]) || (after.antiSnipeExtendMinutes is number && after.antiSnipeExtendMinutes >= 0)) &&
        (!after.keys().hasAny(["bannedUids"]) || (after.bannedUids is list)) &&
        (!after.keys().hasAny(["status"]) || (after.status == "draft" || after.status == "live" || after.status == "ended"));
    }

    function isValidLinkPreviewPayload(data) {
      return data.keys().hasOnly([
          "url",
          "title",
          "image",
          "description",
          "siteName",
          "hostname",
          "fetchedAt"
        ]) &&
        data.url is string &&
        data.url.matches('^https?://.+') &&
        data.url.size() <= 2048 &&
        (data.title == null || (data.title is string && data.title.size() <= 500)) &&
        (data.image == null || (data.image is string && data.image.matches('^https?://.+') && data.image.size() <= 2048)) &&
        (data.description == null || (data.description is string && data.description.size() <= 4000)) &&
        (data.siteName == null || (data.siteName is string && data.siteName.size() <= 255)) &&
        data.hostname is string &&
        data.hostname.size() > 0 &&
        data.hostname.size() <= 255 &&
        data.fetchedAt is number &&
        data.fetchedAt > 0;
    }

    match /trips/{tripId} {
      // Public read so viewers can open invite links without auth.
      allow read: if true;

      // Trip creation must be authenticated and self-owned.
      allow create: if isSignedIn() &&
        request.resource.data.createdByUid == request.auth.uid &&
        hasValidListingUrl(request.resource.data);

      // Manager-only trip lifecycle/settings updates.
      // Also allow signed-in bidders to extend only auctionEndAt (anti-sniping).
      allow update: if (isTripManager(tripId) && hasAllowedManagerTripUpdate(resource.data, request.resource.data)) || (
        isSignedIn() &&
        !isBanned(tripId) &&
        resource.data.status == "live" &&
        resource.data.auctionEndAt is timestamp &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(["auctionEndAt"]) &&
        request.resource.data.auctionEndAt is timestamp &&
        request.time >= resource.data.auctionEndAt - duration.value(10, "m") &&
        request.time <= resource.data.auctionEndAt &&
        request.resource.data.auctionEndAt > resource.data.auctionEndAt &&
        request.resource.data.auctionEndAt <= resource.data.auctionEndAt + duration.value(10, "m")
      );
      allow delete: if isTripManager(tripId);

      match /rooms/{roomId} {
        // Public read for live auction viewing.
        allow read: if true;

        // Room creation/deletion and manager edits stay manager-only.
        allow create, delete: if isTripManager(tripId);

        // Manager can update any room fields.
        // Signed-in bidders can only update current-high-bid tracking fields.
        allow update: if isTripManager(tripId) || (
          isSignedIn() &&
          !isBanned(tripId) &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly([
            "currentHighBidAmount",
            "currentHighBidderUid",
            "currentHighBidAt",
            "currentHighBidTimeMs"
          ]) &&
          request.resource.data.currentHighBidderUid is string &&
          request.resource.data.currentHighBidderUid == request.auth.uid &&
          request.resource.data.currentHighBidAt is timestamp &&
          request.resource.data.currentHighBidAmount is number &&
          (
            !(resource.data.currentHighBidAmount is number) ||
            request.resource.data.currentHighBidAmount > resource.data.currentHighBidAmount ||
            (
              resource.data.currentHighBidAmount == 0 &&
              request.resource.data.currentHighBidAmount == 0 &&
              !(resource.data.currentHighBidderUid is string)
            )
          ) &&
          request.resource.data.currentHighBidTimeMs is number &&
          (
            !(resource.data.currentHighBidTimeMs is number) ||
            request.resource.data.currentHighBidTimeMs >= resource.data.currentHighBidTimeMs
          )
        );

        match /bids/{bidId} {
          // Public read so viewers can see live/final auction history if needed.
          allow read: if true;

          // Only signed-in users can place their own bids.
          allow create: if isSignedIn() &&
            !isBanned(tripId) &&
            tripDoc(tripId).data.status == "live" &&
            (
              !(tripDoc(tripId).data.auctionEndAt is timestamp) ||
              request.time <= tripDoc(tripId).data.auctionEndAt
            ) &&
            request.resource.data.keys().hasOnly(["amount", "bidderUid", "bidTimeMs", "createdAt"]) &&
            request.resource.data.bidderUid == request.auth.uid &&
            request.resource.data.amount is number &&
            request.resource.data.bidTimeMs is number &&
            request.resource.data.createdAt is timestamp;

          // Bids are append-only.
          allow update, delete: if false;
        }
      }

      match /members/{memberUid} {
        // Public read lets viewers see participant display names in live views/results.
        allow read: if true;

        // Users can only create/update their own profile fields.
        // Role escalation is blocked: only the trip creator can use "manager".
        allow create, update: if isSignedIn() &&
          !isBanned(tripId) &&
          request.auth.uid == memberUid &&
          isValidMemberPayload(tripId, memberUid);

        // Manager or self can remove a membership record.
        allow delete: if isTripManager(tripId) || (isSignedIn() && !isBanned(tripId) && request.auth.uid == memberUid);
      }
    }

    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create, update: if request.auth != null && request.auth.uid == uid;
      allow delete: if false;

      match /myTrips/{tripId} {
        allow read, create, update, delete: if isSignedIn() && request.auth.uid == uid;
      }
    }

    match /linkPreviews/{previewId} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() && isValidLinkPreviewPayload(request.resource.data);
      allow delete: if false;
    }
  }
}
